# Web UIè‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼ˆç™¾åº¦æœç´¢ï¼‰- ä¿®æ­£ç‰ˆ
import pytest
import pandas as pd
import os
import time
# ========== æ ¸å¿ƒä¿®æ­£ï¼šSeleniumç›¸å…³å¯¼å…¥é¡ºåº + webdriver-manageræ­£ç¡®å¯¼å…¥ ==========
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager


# ========== è¯»å–æµ‹è¯•ç”¨ä¾‹æ•°æ® ==========
def get_test_cases():
    """è¯»å–Excelä¸­çš„æ‰¹é‡æµ‹è¯•ç”¨ä¾‹"""
    current_path = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(current_path)
    data_path = os.path.join(project_root, "data", "test_cases.xlsx")

    df = pd.read_excel(data_path)
    # è½¬æ¢ä¸ºpytestå¯è¯†åˆ«çš„å‚æ•°åŒ–æ ¼å¼
    test_cases = []
    for _, row in df.iterrows():
        test_cases.append((row["ç”¨ä¾‹ID"], row["æœç´¢å…³é”®è¯"], row["é¢„æœŸç»“æœï¼ˆåŒ…å«å…³é”®è¯ï¼‰"]))
    return test_cases


# ========== åˆå§‹åŒ–æµè§ˆå™¨é©±åŠ¨ ==========
@pytest.fixture(scope="module")
def driver():
    """å…¨å±€æµè§ˆå™¨é©±åŠ¨ï¼Œæ‰€æœ‰ç”¨ä¾‹å…±ç”¨ä¸€ä¸ªæµè§ˆå™¨å®ä¾‹"""
    # è‡ªåŠ¨ä¸‹è½½Chromeé©±åŠ¨å¹¶åˆå§‹åŒ–
    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service)
    driver.maximize_window()  # çª—å£æœ€å¤§åŒ–
    driver.implicitly_wait(10)  # éšå¼ç­‰å¾…10ç§’ï¼ˆå…ƒç´ åŠ è½½è¶…æ—¶ï¼‰
    yield driver  # æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
    driver.quit()  # æ‰€æœ‰ç”¨ä¾‹æ‰§è¡Œå®Œå…³é—­æµè§ˆå™¨


# ========== æ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹ ==========
@pytest.mark.parametrize("case_id, keyword, expected", get_test_cases())
def test_baidu_search(driver, case_id, keyword, expected):
    """ç™¾åº¦æœç´¢UIè‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹"""
    try:
        # 1. æ‰“å¼€ç™¾åº¦é¦–é¡µ
        driver.get("https://www.baidu.com")

        # 2. å®šä½æœç´¢æ¡†ï¼Œè¾“å…¥å…³é”®è¯
        search_box = driver.find_element(By.ID, "kw")
        search_box.clear()  # æ¸…ç©ºè¾“å…¥æ¡†
        search_box.send_keys(keyword)
        time.sleep(1)  # æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥å»¶è¿Ÿ

        # 3. ç‚¹å‡»æœç´¢æŒ‰é’®ï¼ˆæˆ–æŒ‰å›è½¦ï¼‰
        search_box.send_keys(Keys.ENTER)
        time.sleep(2)  # ç­‰å¾…æœç´¢ç»“æœåŠ è½½

        # 4. æ–­è¨€ï¼šæœç´¢ç»“æœåŒ…å«é¢„æœŸå†…å®¹
        page_source = driver.page_source
        assert expected in page_source, f"ç”¨ä¾‹{case_id}å¤±è´¥ï¼šæœªæ‰¾åˆ°é¢„æœŸå†…å®¹ã€Œ{expected}ã€"

        print(f"âœ… ç”¨ä¾‹{case_id}é€šè¿‡ï¼šæœç´¢ã€Œ{keyword}ã€ï¼ŒéªŒè¯ç»“æœåŒ…å«ã€Œ{expected}ã€")

    except Exception as e:
        # æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œæ ‡è®°ç”¨ä¾‹å¤±è´¥
        pytest.fail(f"ç”¨ä¾‹{case_id}å¤±è´¥ï¼š{str(e)}")


# ========== ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š ==========
if __name__ == "__main__":
    # å®šä¹‰æŠ¥å‘Šä¿å­˜è·¯å¾„
    current_path = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(current_path)
    report_path = os.path.join(project_root, "reports", "baidu_test_report.html")

    # æ‰§è¡Œpytestå¹¶ç”ŸæˆHTMLæŠ¥å‘Š
    pytest.main([
        __file__,
        "-v",  # è¯¦ç»†è¾“å‡º
        "--html=" + report_path,  # æŠ¥å‘Šè·¯å¾„
        "--self-contained-html"  # æŠ¥å‘ŠåŒ…å«æ‰€æœ‰èµ„æºï¼ˆå›¾ç‰‡/CSSï¼‰
    ])
    print(f"\nğŸ“Š æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆï¼š{report_path}")